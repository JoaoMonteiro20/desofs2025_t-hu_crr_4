name: DAST - OWASP ZAP

on:
  push:
    branches: [ feature-DAST ]
  workflow_dispatch:

jobs:
  dast:
    name: Run OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Start containers
        run: docker compose up -d

      - name: Wait for API to be ready
        run: sleep 15

      - name: Criar diretório para os relatórios
        run: mkdir zap-results

      - name: Verificar se API está a responder
        run: |
            curl -v http://localhost:7020 || echo "API não respondeu"

      - name: Criar diretório para resultados ZAP
        run: mkdir -p zap-results

      - name: Run ZAP Baseline Scan
        run: |
          docker run --rm \
            --network ecoimpact_default \
            -v ${{ github.workspace }}/zap-results:/zap/wrk/:rw \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://ecoimpact-api:7020 \
            -r zap-report.html || true  # <-- evita falha do job por exit 2




      # - name: Run ZAP Baseline Scan via Docker
      #   run: |
      #     docker run --rm \
      #       -v ${{ github.workspace }}/zap-results:/zap/wrk/:rw \
      #       ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
      #       -t http://localhost:7020 \
      #       -r zap-report.html \
      #       -J zap-report.json \
      #       -w zap-report.md \
      #       -a


      # - name: Run ZAP Baseline Scan via Docker
      #   run: |
      #     docker run --rm \
      #       -v ${{ github.workspace }}/zap-results:/zap/wrk/:rw \
      #       ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
      #       -t http://localhost:7020 \
      #       -J zap-report.json \
      #       -w zap-report.md \
      #       -r zap-report.html \
      #       -a

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zapscan
          path: zap-results/

      - name: Stop containers
        run: docker compose down

# name: DAST - OWASP ZAP

# on:
#   push:
#     branches:
#       - feature-DAST
#   workflow_dispatch:

# jobs:
#   dast:
#     name: Run OWASP ZAP Baseline Scan
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Start containers
#         run: docker compose up -d

#       - name: Wait for API to be ready
#         run: sleep 15

#       - name: Run ZAP Baseline Scan
#         uses: zaproxy/action-baseline@v0.10.0
#         with:
#           target: "http://localhost:7020"
#           cmd_options: '-a'

#       - name: Upload ZAP Report
#         uses: actions/upload-artifact@v4
#         with:
#           name: zapscan
#           path: |
#             report_json.json
#             report_md.md
#             report_html.html

#       - name: Stop containers
#         run: docker compose -f docker-compose.yml down
